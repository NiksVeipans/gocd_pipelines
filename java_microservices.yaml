---
format_version: 10
common:
    deploy-tasks: &deploy-tasks
        - exec:
            command: bash
            arguments:
                - -c
                - echo "Deploy on ${ENV_NAME} environment"
    test-tasks: &test-tasks
        - exec:
            command: bash
            arguments:
                - -c
                - echo "Running tests on ${ENV_NAME} environment"

pipelines:
    java_microservice:
        group: microservices
        lock_behavior: unlockWhenFinished
        label_template: "${git_java_microservice}"
        materials: 
            git_java_microservice:
                git: https://github.com/mtararujs/api_tests_ci.git
                branch: main
                shallow_clone: true
                auto_update: true
        stages: 
            - build:
                jobs:
                    build:
                        tasks:
                            - exec:
                                command: bash
                                arguments:
                                    - -c
                                    - echo "Building java app"
            - deploy-dev:
                environment-variables:
                    ENV_NAME: dev
                jobs:
                    deploy:
                        tasks: *deploy-tasks
            - test-dev:
                environment-variables:
                    ENV_NAME: dev
                jobs:
                    deploy:
                        tasks: *test-tasks
            - deploy-int:
                environment-variables:
                    ENV_NAME: int
                jobs:
                    deploy:
                        tasks: *deploy-tasks
            - test-int:
                environment-variables:
                    ENV_NAME: int
                jobs:
                    deploy:
                        tasks: *test-tasks
            - deploy-dev:
                environment-variables:
                    ENV_NAME: prd
                jobs:
                    deploy:
                        tasks: *deploy-tasks
            - test-dev:
                environment-variables:
                    ENV_NAME: prd
                jobs:
                    deploy:
                        tasks: *test-tasks
            